<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Koin - Cari Koin</title>

    <style>
      :root {
        --bg-game: #a29bfe;
        --bg-card: #ffffff;
        --text-dark: #333;
        --primary-blue: #007bff;
        --success-green: #28a745;
        --danger-red: #dc3545;
        --hadiah-gold: #ffc107;
        --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      body {
        font-family: "Poppins", sans-serif;
        text-align: center;
        background-color: var(--bg-game);
        color: var(--text-dark);
        padding: 20px;
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        outline: none;
      }

      #game-container {
        width: 95%;
        max-width: 800px;
        background-color: var(--bg-card);
        padding: 30px;
        border-radius: 15px;
        box-shadow: var(--shadow-light);
        margin-top: 50px;
      }

      h1 {
        color: var(--primary-blue);
        font-size: 2em;
      }

      #koin-status {
        font-size: 1.3em;
        margin-bottom: 20px;
        font-weight: 500;
      }

      #koin-count {
        font-size: 2.5em;
        color: #b38800;
        font-weight: 800;
        display: block;
      }

      #controls-info {
        font-weight: 600;
        color: var(--primary-blue-dark);
        margin-bottom: 15px;
        padding: 5px;
        border: 1px dashed var(--primary-blue);
        border-radius: 5px;
      }

      #button-controls {
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .control-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: transform 0.1s;
      }

      #start-game-btn {
        background-color: var(--success-green);
      }

      #stop-game-btn {
        background-color: var(--danger-red);
      }

      #back-btn {
        background-color: var(--primary-blue);
      }

      #reset-koin-btn {
        background-color: #6c757d;
        margin-left: 15px;
      }

      .control-btn:hover {
        transform: translateY(-2px);
      }

      /* --- Simulasi Game --- */
      #game-area {
        width: 100%;
        height: 400px;
        background-color: #ecf0f1;
        border: 5px solid #bdc3c7;
        border-radius: 10px;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
        padding-bottom: 20px;
      }

      #ember {
        position: absolute;
        bottom: 0;
        left: 0;
        transform: translateX(0%);
        width: 100px;
        height: 50px;
        background-color: #34495e;
        border-radius: 0 0 10px 10px;
        border: 5px solid #2c3e50;
        cursor: grab;
        touch-action: none;
        z-index: 10;
      }

      .falling-coin {
        position: absolute;
        top: -20px;
        width: 25px;
        height: 25px;
        background-color: var(--hadiah-gold);
        border-radius: 50%;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        font-size: 14px;
        line-height: 25px;
        text-align: center;
        animation: fall 2s linear forwards;
        color: #b38800;
      }

      @keyframes fall {
        0% {
          transform: translateY(0);
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(450px);
          opacity: 0.5;
        }
      }

      /* ========================================================= */
      /* --- RESPONSIVE CSS (MOBILE VIEW) --- */
      /* ========================================================= */
      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        #game-container {
          padding: 15px;
          margin-top: 20px;
        }
        h1 {
          font-size: 1.6em;
        }
        p {
          font-size: 0.9em;
        }
        #koin-status {
          font-size: 1.1em;
        }
        #koin-count {
          font-size: 2em;
        }

        /* Area Game & Ember */
        #game-area {
          height: 300px; /* Sedikit dikecilkan untuk menghemat ruang */
        }
        #ember {
          width: 70px; /* Ember dikecilkan */
          height: 35px;
        }
        /* Koin juga harus berakhir di posisi yang benar sesuai tinggi baru */
        @keyframes fall {
          0% {
            transform: translateY(0);
            opacity: 1;
          }
          90% {
            opacity: 1;
          }
          /* 300px tinggi area + 35px tinggi ember */
          100% {
            transform: translateY(335px);
            opacity: 0.5;
          }
        }

        /* Kontrol tombol */
        #button-controls {
          flex-direction: column;
          gap: 10px;
        }
        .control-btn {
          padding: 10px 15px;
          font-size: 0.9em;
        }

        /* Tombol Kembali/Reset */
        div > button {
          width: 48%; /* Agar bisa sejajar 2 tombol */
          margin-left: 0 !important; /* Overwrite margin-left: 15px; */
        }
      }
    </style>
  </head>
  <body onload="initKoinGame();" tabindex="0">
    <div id="game-container">
      <h1>Cari Koin Sekarang!</h1>
      <p>
        Tangkap koin berjatuhan untuk menambah saldo. Rasio: **1 Koin Jatuh = 1
        Koin Didapat** (5 koin/detik)
      </p>

      <div id="controls-info">
        Gunakan **Mouse/Jari** untuk **menyeret (drag)** ember di area game!
      </div>

      <div id="koin-status">
        Koin yang didapat sesi ini: <span id="session-koin">0</span>
        <span id="koin-count"></span>
      </div>

      <div id="button-controls">
        <button id="start-game-btn" class="control-btn" onclick="startGame()">
          Mulai Tangkap Koin
        </button>
        <button
          id="stop-game-btn"
          class="control-btn"
          onclick="stopGame()"
          disabled
        >
          Stop & Simpan
        </button>
      </div>

      <div id="game-area">
        <div id="ember"></div>
      </div>

      <div
        style="
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-top: 20px;
        "
      >
        <button
          id="back-btn"
          class="control-btn"
          onclick="window.location.href='newroa.html'"
        >
          Kembali ke Halaman Gacha
        </button>
        <button id="reset-koin-btn" class="control-btn" onclick="resetKoin()">
          Reset Total Koin (0)
        </button>
      </div>
    </div>

    <script>
      const KOIN_PER_FALLING_COIN = 1;
      const FALL_FREQUENCY_MS = 200;

      // CATCH_CHECK_TIME dihitung ulang berdasarkan tinggi area game
      // Jika tinggi area 400px (default), check 1800ms. Jika 300px (mobile), perlu lebih cepat.
      const ANIMATION_DURATION = 2000;
      let CATCH_CHECK_TIME = 1800; // Akan di-update saat init

      const SUCCESS_COLOR = "#28a745";
      const GOLD_COLOR = "#b38800";

      let gameInterval = null;
      let coinSpawnInterval = null;
      let sessionKoin = 0;
      let baseKoin = 0;
      let isGameRunning = false;

      let ember;
      let gameArea;
      let gameAreaRect;
      let isDragging = false;

      function getKoin() {
        return parseInt(localStorage.getItem("userKoin")) || 0;
      }

      function initKoinGame() {
        if (localStorage.getItem("userKoin") === null) {
          localStorage.setItem("userKoin", 0);
        }
        ember = document.getElementById("ember");
        gameArea = document.getElementById("game-area");

        // Atur ulang CATCH_CHECK_TIME berdasarkan tinggi area game saat ini
        CATCH_CHECK_TIME =
          ANIMATION_DURATION *
          (gameArea.clientHeight /
            (gameArea.clientHeight + ember.clientHeight + 20));

        updateKoinStatus();
        setupEmberControls();
      }

      function updateKoinStatus() {
        baseKoin = getKoin();
        document.getElementById("koin-count").textContent = `Total Koin: ${
          baseKoin + sessionKoin
        }`;
        document.getElementById("session-koin").textContent = sessionKoin;
      }

      function resetKoin() {
        const confirmReset = confirm(
          "Apakah Anda yakin ingin me-reset SEMUA Koin Anda menjadi 0? Tindakan ini tidak dapat dibatalkan."
        );

        if (confirmReset) {
          localStorage.setItem("userKoin", 0);
          sessionKoin = 0;
          baseKoin = 0;
          updateKoinStatus();
          document.getElementById("koin-status").innerHTML = `
                    <p style='color: ${SUCCESS_COLOR}; font-weight: bold;'>âœ… Total Koin berhasil di-reset menjadi 0.</p>
                    <span id="session-koin">0</span>
                    <span id="koin-count">Total Koin: 0</span>
                `;
        }
      }

      function startGame() {
        if (coinSpawnInterval !== null) return;

        document.getElementById("start-game-btn").disabled = true;
        document.getElementById("stop-game-btn").disabled = false;
        document.getElementById("back-btn").disabled = true;
        document.getElementById("reset-koin-btn").disabled = true;

        sessionKoin = 0;
        baseKoin = getKoin();
        isGameRunning = true;

        gameAreaRect = gameArea.getBoundingClientRect();

        ember.style.left = `${
          gameArea.clientWidth / 2 - ember.clientWidth / 2
        }px`;

        document.getElementById("koin-status").innerHTML = `
                Koin yang didapat sesi ini: <span id="session-koin">0</span>
                <span id="koin-count"></span>
            `;

        updateKoinStatus();

        coinSpawnInterval = setInterval(spawnCoin, FALL_FREQUENCY_MS);
      }

      function stopGame() {
        clearInterval(coinSpawnInterval);
        coinSpawnInterval = null;

        document.getElementById("stop-game-btn").disabled = true;
        document.getElementById("start-game-btn").disabled = false;
        document.getElementById("reset-koin-btn").disabled = false;

        isGameRunning = false;

        const finalKoin = baseKoin + sessionKoin;
        localStorage.setItem("userKoin", finalKoin);

        document.getElementById("koin-status").innerHTML = `
                ðŸŽ‰ Berhasil! Anda mendapatkan <b style="color: ${SUCCESS_COLOR};">${sessionKoin} Koin</b>. 
                <br>Total Koin Sekarang: <span id="koin-count" style="color: ${GOLD_COLOR};">${finalKoin}</span>
            `;

        document
          .querySelectorAll(".falling-coin")
          .forEach((coin) => coin.remove());

        document.getElementById("back-btn").disabled = false;
      }

      function spawnCoin() {
        const coin = document.createElement("div");
        coin.classList.add("falling-coin");
        coin.textContent = "$";

        const coinWidth = 25; // Lebar koin
        const randomX = Math.random() * (gameArea.clientWidth - coinWidth);
        coin.style.left = `${randomX}px`;

        gameArea.appendChild(coin);

        const emberWidth = ember.clientWidth;

        // --- LOGIKA DETEKSI TANGKAPAN BARU (Menggunakan CATCH_CHECK_TIME yang dinamis) ---
        setTimeout(() => {
          if (!isGameRunning) return;

          const coinLeft = parseFloat(coin.style.left);
          const emberLeft =
            parseFloat(ember.style.left) ||
            gameArea.clientWidth / 2 - emberWidth / 2;
          const emberRight = emberLeft + emberWidth;

          // Cek apakah koin (lebar 25px) berada di antara tepi kiri dan kanan ember
          // Toleransi 10px dari kiri dan 15px dari kanan koin.
          const isHorizontallyAligned =
            coinLeft + 10 >= emberLeft && coinLeft + 15 <= emberRight;

          if (isHorizontallyAligned) {
            sessionKoin += KOIN_PER_FALLING_COIN;
            updateKoinStatus();

            coin.style.animation = "none";
            coin.style.opacity = "0";
          }
        }, CATCH_CHECK_TIME);

        // CLEANUP: Hapus coin setelah animasi 2 detik selesai (2000ms)
        setTimeout(() => {
          if (gameArea.contains(coin)) {
            gameArea.removeChild(coin);
          }
        }, ANIMATION_DURATION);
      }

      // --- LOGIKA KONTROL MOUSE / SENTUH ---
      function setupEmberControls() {
        ember.addEventListener("mousedown", startDrag);
        document.addEventListener("mouseup", endDrag);
        document.addEventListener("mousemove", drag);

        ember.addEventListener("touchstart", startDrag);
        document.addEventListener("touchend", endDrag);
        document.addEventListener("touchmove", drag);
      }

      function startDrag(e) {
        if (!isGameRunning) return;
        e.preventDefault();
        isDragging = true;
        ember.style.cursor = "grabbing";
        gameAreaRect = gameArea.getBoundingClientRect();
      }

      function endDrag() {
        if (!isGameRunning) return;
        isDragging = false;
        ember.style.cursor = "grab";
      }

      function drag(e) {
        if (!isDragging || !isGameRunning) return;

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let relativeX = clientX - gameAreaRect.left;
        let newEmberX = relativeX - ember.clientWidth / 2;

        if (newEmberX < 0) {
          newEmberX = 0;
        }
        if (newEmberX > gameArea.clientWidth - ember.clientWidth) {
          newEmberX = gameArea.clientWidth - ember.clientWidth;
        }

        ember.style.left = `${newEmberX}px`;
      }
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </body>
</html>
